name: Terraform Apply

on:
  push:
    # branches:
    #   - main
    # paths:
    #   - 'lambda/**.py'
    #   - 'requirements.txt'
    #   - 'main.tf'

jobs:
  lambda_layer_pip_install:
    runs-on: ubuntu-latest
    name: Install Python Dependencies for Lambda Layer
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip' # caching pip dependencies
      - run: pip install -r requirements.txt -t ./build/python/

  test:
    runs-on: ubuntu-latest
    name: Test
    steps:
      - name: List contents of the build directory
        run: ls -R ./build

  terraform_apply:
    runs-on: ubuntu-latest
    needs: lambda_layer_pip_install
    name: Terraform Apply
    steps:
      - uses: actions/checkout@v4
      - name: terraform apply
        uses: dflook/terraform-apply@v1
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.aws_secret_access_key }}
        with:
          path: .
          variables: |
            aws_region = "${{ secrets.aws_region }}"
            aws_account_id = "${{ secrets.aws_account_id }}"
            open_ai_api_key = "${{ secrets.open_ai_api_key }}"
            slack_bot_token = "${{ secrets.slack_bot_token }}"
            slack_signing_secret = "${{ secrets.slack_signing_secret }}"
          auto_approve: false
